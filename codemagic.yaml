workflows:
  ios_ipa_unsigned:
    name: iOS — Unsigned IPA (no codesign)
    environment:
      flutter: stable
      xcode: 15.4
      cocoapods: default
    cache:
      cache_paths:
        - ~/.pub-cache
        - ios/Pods
    scripts:
      - name: Flutter pub get
        script: |
          set -e
          flutter pub get

      - name: Ensure iOS folder exists
        script: |
          set -e
          if [ ! -d ios ]; then
            flutter create .
          fi

      - name: Set identifiers + min iOS
        script: |
          set -e
          BUNDLE_ID=com.wesam.mda.pro
          DISPLAY_NAME="Market Data Pro"

          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" ios/Runner/Info.plist || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $DISPLAY_NAME" ios/Runner/Info.plist || true
          plutil -replace MinimumOSVersion -string "13.0" ios/Runner/Info.plist || true

          # iOS 13 في Podfile
          if grep -q "platform :ios" ios/Podfile; then
            sed -i '' "s/platform :ios, '.*'/platform :ios, '13.0'/" ios/Podfile
          else
            echo "platform :ios, '13.0'" | cat - ios/Podfile > /tmp/Podfile && mv /tmp/Podfile ios/Podfile
          fi

      - name: Clean & install CocoaPods
        script: |
          set -e
          cd ios
          rm -rf Pods Podfile.lock
          pod repo update
          pod install
          cd ..

      - name: Build IPA (Flutter, no codesign)
        script: |
          set -e
          flutter clean
          # يبني IPA مباشرة بدون توقيع ويضعها في build/ios/ipa/
          flutter build ipa --release --no-codesign

      - name: Collect IPA
        script: |
          set -e
          ls -la build/ios || true
          ls -la build/ios/ipa || true
          # عادة يكون الاسم Runner.ipa
          if [ -f build/ios/ipa/Runner.ipa ]; then
            cp build/ios/ipa/Runner.ipa Runner-unsigned.ipa
          else
            # لو تغيّر الاسم، خذه أول ipa
            IPA_PATH=$(ls build/ios/ipa/*.ipa | head -n 1)
            if [ -z "$IPA_PATH" ]; then
              echo "No IPA found under build/ios/ipa"; exit 1
            fi
            cp "$IPA_PATH" Runner-unsigned.ipa
          fi

    artifacts:
      - Runner-unsigned.ipa
